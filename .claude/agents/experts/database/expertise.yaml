# Database Expert Expertise - teach-niche-v0
# Target: 650-750 lines | Domain: Supabase schema and migrations
# Last Discovery: 2025-12-30 | Status: Initial Setup Complete

overview:
  description: |
    Database domain expertise for teach-niche-v0 Supabase PostgreSQL schema.
    Manages migrations, TypeScript type generation, RLS policies, storage buckets,
    and database functions. Discovered from comprehensive codebase analysis.
  scope: |
    - Supabase CLI workflows (gen types, db diff, db push, migration new)
    - Migration management (11 active files, 816 total lines)
    - Schema-to-TypeScript type generation (types/supabase.ts, 186 lines)
    - RLS policies (table-level and storage bucket security)
    - Database functions (SECURITY DEFINER, access verification)
    - Storage buckets (thumbnails public, videos private with signed URLs)
    - Query patterns (server-side client, typed responses)
    - Test infrastructure (mocking, cleanup utilities)

  rationale: |
    Database is source of truth for teach-niche data model. Codebase currently
    has 186-line MANUAL types/supabase.ts maintained by hand (last updated
    2025-04-25). Migration history shows iterative RLS policy refinement,
    video security hardening, and purchase verification evolution.

core_schema:
  tables:
    users:
      purpose: User profiles (references auth.users)
      columns:
        - id UUID PRIMARY KEY REFERENCES auth.users(id)
        - name TEXT
        - bio TEXT
        - role TEXT DEFAULT 'user'
        - created_at TIMESTAMPTZ
        - updated_at TIMESTAMPTZ
      rls_policies:
        - "Users can view all users" (SELECT, true)
        - "Users can update their own profile" (UPDATE, auth.uid() = id)
      triggers:
        - users_updated_at_trigger (BEFORE UPDATE)
      evidence: supabase/migrations/20250403000000_consolidated_schema.sql:52-59

    instructor_profiles:
      purpose: Stripe Connect account linkage for instructors
      columns:
        - id UUID PRIMARY KEY
        - user_id UUID REFERENCES auth.users(id)
        - stripe_account_id TEXT
        - stripe_account_enabled BOOLEAN DEFAULT FALSE
        - stripe_onboarding_complete BOOLEAN DEFAULT FALSE
        - total_earnings NUMERIC DEFAULT 0
        - name TEXT
        - bio TEXT
        - created_at TIMESTAMPTZ
        - updated_at TIMESTAMPTZ
      rls_policies:
        - "Anyone can view instructor profiles" (SELECT, true)
        - "Users can update their own instructor profile" (UPDATE, auth.uid() = user_id)
        - "Users can insert their own instructor profile" (INSERT, auth.uid() = user_id)
      triggers:
        - instructor_profiles_updated_at_trigger (BEFORE UPDATE)
        - set_instructor_role_trigger (AFTER INSERT, sets users.role = 'instructor')
      evidence: supabase/migrations/20250403000000_consolidated_schema.sql:62-73
      stripe_integration: Added via 20250404000000_add_stripe_connect_fields.sql

    lessons:
      purpose: Core content entity (1:1 with videos, replaced multi-video model)
      columns:
        - id UUID PRIMARY KEY
        - title TEXT NOT NULL
        - description TEXT
        - instructor_id UUID REFERENCES auth.users(id)
        - price NUMERIC NOT NULL
        - thumbnail_url TEXT
        - video_url TEXT
        - videos_count INTEGER DEFAULT 0 (legacy field)
        - parent_lesson_id UUID REFERENCES lessons(id) (legacy field)
        - stripe_product_id TEXT
        - stripe_price_id TEXT
        - is_published BOOLEAN DEFAULT false
        - created_at TIMESTAMPTZ
        - updated_at TIMESTAMPTZ
      rls_policies:
        - "Anyone can view lessons" (SELECT, true)
        - "Users can view lessons they have purchased" (SELECT via user_has_purchased_lesson)
        - "Public can view free lessons" (SELECT, price = 0 OR NULL)
        - "Instructors can insert their own lessons" (INSERT, auth.uid() = instructor_id)
        - "Instructors can update their own lessons" (UPDATE, auth.uid() = instructor_id)
        - "Instructors can delete their own lessons" (DELETE, auth.uid() = instructor_id)
      evidence: supabase/migrations/20250403000000_consolidated_schema.sql:76-90
      refactoring: Moved from multi-video to one-to-one (commit 2359c3d, 2025-04-03)

    purchases:
      purpose: Transaction records (free + paid) with Stripe metadata
      columns:
        - id UUID PRIMARY KEY
        - user_id UUID REFERENCES auth.users(id)
        - lesson_id UUID REFERENCES lessons(id)
        - video_id UUID (legacy, nullable, migration path exists)
        - stripe_payment_id VARCHAR NOT NULL (free_* prefix for free lessons)
        - stripe_product_id VARCHAR
        - stripe_price_id VARCHAR
        - amount NUMERIC NOT NULL
        - instructor_payout_amount NUMERIC
        - platform_fee_amount NUMERIC
        - payout_status TEXT DEFAULT 'pending'
        - stripe_transfer_id TEXT
        - is_free BOOLEAN DEFAULT false
        - created_at TIMESTAMPTZ
      rls_policies:
        - "System can insert purchases" (INSERT, true)
        - "Users can view their own purchases" (SELECT, auth.uid() = user_id)
      evidence: supabase/migrations/20250403000000_consolidated_schema.sql:93-104
      free_lesson_support: Added via 20250404010000_add_free_lesson_support.sql
      stripe_fields: Added via 20250404000000_add_stripe_connect_fields.sql

    videos:
      purpose: Legacy table (test schema only, not in production)
      status: Re-added in 20250505020000_fix_test_schema.sql for test compatibility
      columns:
        - id UUID PRIMARY KEY
        - title TEXT NOT NULL
        - description TEXT
        - video_url TEXT
        - thumbnail_url TEXT
        - price NUMERIC DEFAULT 0
        - instructor_id UUID REFERENCES auth.users(id)
        - lesson_id UUID REFERENCES lessons(id)
        - stripe_product_id TEXT
        - stripe_price_id TEXT
        - is_published BOOLEAN DEFAULT false
        - created_at TIMESTAMPTZ
        - updated_at TIMESTAMPTZ
      evidence: supabase/migrations/20250505020000_fix_test_schema.sql:8-22
      rationale: Tests still reference video entities, maintains backward compatibility

  views:
    user_purchased_lessons:
      purpose: Denormalized view of purchases + lessons (includes instructor access)
      definition: |
        SELECT p.user_id, p.lesson_id, l.title, l.description, l.thumbnail_url,
               l.video_url, l.price, l.instructor_id, p.created_at AS purchase_date
        FROM purchases p JOIN lessons l ON p.lesson_id = l.id
        UNION ALL
        SELECT l.instructor_id AS user_id, l.id AS lesson_id, l.title, l.description,
               l.thumbnail_url, l.video_url, l.price, l.instructor_id, l.created_at
        FROM lessons l WHERE l.instructor_id IS NOT NULL
      evolution: Enhanced to include instructor access (20250503000000)
      evidence: supabase/migrations/20250503000000_improved_purchase_verification.sql:60-90

  functions:
    column_exists:
      signature: column_exists(table_name text, column_name text) RETURNS boolean
      purpose: Schema introspection for migration compatibility
      security: plpgsql
      evidence: supabase/migrations/20250403000000_consolidated_schema.sql:5-19
      usage: app/api/verify-lesson-purchase/route.ts:162 (video_id column check)

    update_updated_at_column:
      signature: update_updated_at_column() RETURNS TRIGGER
      purpose: Auto-update updated_at timestamp on row changes
      evidence: supabase/migrations/20250403000000_consolidated_schema.sql:22-28

    check_lesson_access:
      signature: check_lesson_access(lesson_id uuid, user_id uuid) RETURNS boolean
      purpose: Verify user access to lesson (purchase, free, or instructor)
      security: SECURITY DEFINER
      logic: |
        1. Check if lesson is free (price = 0 OR NULL) → grant access
        2. Check if user purchased lesson → grant access
        3. Otherwise deny
      evidence: supabase/migrations/20250404010000_add_free_lesson_support.sql:8-31

    user_has_purchased_lesson:
      signature: user_has_purchased_lesson(user_id UUID, lesson_id UUID) RETURNS BOOLEAN
      purpose: Enhanced purchase verification (replaces check_lesson_access)
      security: SECURITY DEFINER
      logic: |
        1. Check exact purchase match (user_id + lesson_id)
        2. Check if lesson is free (price = 0 OR NULL)
        3. Check if user is lesson instructor
      evidence: supabase/migrations/20250503000000_improved_purchase_verification.sql:2-39
      usage: RLS policy "Users can view lessons they have purchased"

    has_purchased_lesson:
      signature: has_purchased_lesson(user_id UUID, lesson_id UUID) RETURNS BOOLEAN
      purpose: Simple purchase check (no free/instructor logic)
      security: SECURITY DEFINER
      evidence: supabase/migrations/20250505010000_add_access_verification_functions.sql:4-18

    has_video_access:
      signature: has_video_access(user_id UUID, lesson_id UUID) RETURNS BOOLEAN
      purpose: Video access check (creator OR purchaser)
      security: SECURITY DEFINER
      evidence: supabase/migrations/20250505010000_add_access_verification_functions.sql:21-46

    get_purchases_by_video_ids:
      signature: get_purchases_by_video_ids(video_ids UUID[]) RETURNS SETOF purchases
      purpose: Legacy video_id column compatibility
      security: SECURITY DEFINER
      logic: Checks if video_id column exists before querying
      evidence: supabase/migrations/20250504000000_add_video_purchases_function.sql:3-28

    verify_video_access:
      signature: verify_video_access(p_user_id uuid, p_video_id uuid) RETURNS boolean
      purpose: Video entity access verification (test schema)
      security: SECURITY DEFINER
      evidence: supabase/migrations/20250505020000_fix_test_schema.sql:32-72

  storage_buckets:
    thumbnails:
      public: true
      policies:
        - "Allow Public Access 16v3daf_0" (SELECT, bucket_id = 'thumbnails')
        - "Allow authenticated uploads 16v3daf_0" (INSERT, authenticated)
      evidence: supabase/migrations/20250403000000_consolidated_schema.sql:166-192

    videos:
      public: false (CRITICAL CHANGE: 20250426000000 migration)
      security_model: Signed URLs with 30-day expiry
      policies:
        - "authenticated_uploads_videos" (INSERT, authenticated)
        - "instructor_video_access" (SELECT, instructor owns lesson)
        - "purchased_video_access" (SELECT, user purchased lesson)
        - "free_video_access" (SELECT, lesson price = 0)
        - "Allow access to purchased videos" (SELECT via RLS path check)
      path_format: "lesson_id/filename.ext"
      evidence: supabase/migrations/20250426000000_fix_video_bucket_security.sql
      video_url_normalization: Migration fixes public URLs → paths (lines 93-131)
      server_helper: lib/supabase/server-utils.ts:refreshVideoUrlServer

migration_history:
  baseline:
    file: 20250403000000_consolidated_schema.sql
    description: Consolidated baseline (217 lines)
    tables_created: users, instructor_profiles, lessons, purchases
    storage_buckets: thumbnails, videos
    evidence: Git log shows this replaced earlier sequential migrations

  stripe_integration:
    - file: 20250404000000_add_stripe_connect_fields.sql (12 lines)
      changes: Added platform_fee_amount, payout_status, stripe_transfer_id to purchases
      changes: Added total_earnings to instructor_profiles

  free_lessons:
    - file: 20250404010000_add_free_lesson_support.sql (33 lines)
      changes: Added is_free BOOLEAN to purchases
      changes: Created check_lesson_access function (free lesson logic)
      changes: Added idx_purchases_is_free index

  video_security:
    - file: 20250426000000_fix_video_bucket_security.sql (157 lines)
      changes: Set videos bucket to public = false
      changes: Dropped "Allow Public Access Videos" policy
      changes: Created RLS policies for instructor/purchaser/free access
      changes: Normalized video_url paths (removed URLs, query params, prefixed lesson_id)
      impact: Breaking change - all video access now requires signed URLs
      evidence: Emergency rollback section commented out (lines 133-158)

  purchase_verification:
    - file: 20250503000000_improved_purchase_verification.sql (89 lines)
      changes: Created user_has_purchased_lesson function (replaces check_lesson_access)
      changes: Enhanced user_purchased_lessons view to UNION instructor-owned lessons
      changes: Added RLS policies using new function

    - file: 20250504000000_add_video_purchases_function.sql (66 lines)
      changes: Created get_purchases_by_video_ids for legacy video_id column
      changes: Created handle_legacy_purchases procedure (migrate video_id → lesson_id)

  rls_policies:
    - file: 20250505000000_enable_rls_all_tables.sql (32 lines)
      changes: Enabled RLS on users, instructor_profiles, lessons
      changes: Created comprehensive SELECT/UPDATE/INSERT/DELETE policies
      changes: Granted authenticated/anon permissions

    - file: 20250505010000_add_access_verification_functions.sql (71 lines)
      changes: Created has_purchased_lesson and has_video_access functions
      changes: Created storage.objects policy "Allow access to purchased videos"
      changes: Uses SPLIT_PART to extract lesson_id from video paths

  test_schema:
    - file: 20250505020000_fix_test_schema.sql (73 lines)
      changes: Re-added videos table with is_published column
      changes: Created verify_video_access function
      changes: Added RLS policies for videos table
      rationale: Tests reference video entities, maintains backward compatibility

  remote_schema_snapshots:
    - file: 20250403185732_remote_schema.sql (35 lines)
    - file: 20250403185938_remote_schema.sql (31 lines)
    purpose: Point-in-time remote schema dumps for reference

  total_migrations: 11 active files
  total_lines: 816 lines of SQL
  date_range: 2025-04-03 to 2025-05-07
  commits_analyzed: 22 database-related commits (April-May 2025)

type_generation:
  current_state:
    file: types/supabase.ts
    lines: 186 lines (actual count from wc -l)
    method: MANUAL maintenance
    last_updated: 2025-04-25 (commit aae1770 "fixed purchase flow")
    drift_risk: HIGH (types haven't been regenerated since schema changes)

  structure:
    export_types:
      - Json (union type for JSON values)
      - Database (interface with public.Tables/Views/Functions)
      - Purchase (Row type for purchases table)
      - Lesson (Row type for lessons table)
      - UserPurchasedLesson (Row type for view)
      - InstructorProfile (Row type for instructor_profiles)
      - User (Row type for users table)
    tables:
      users: Row/Insert/Update interfaces
      purchases: Row/Insert/Update interfaces (includes is_free, stripe_transfer_id)
      lessons: Row/Insert/Update interfaces
      instructor_profiles: Row/Insert/Update interfaces
    views:
      user_purchased_lessons: Row interface (no Insert/Update)
    functions:
      check_lesson_access: Args/Returns types

  automation_recommendation:
    package_json_script: |
      "scripts": {
        "types:generate": "npx supabase gen types typescript --local > types/supabase.ts",
        "db:reset": "npx supabase db reset && pnpm types:generate"
      }
    workflow: |
      1. After creating migration: npx supabase db reset
      2. Regenerate types: pnpm types:generate
      3. Commit both migration + regenerated types together
    trade_off: Requires Supabase CLI vs current manual maintenance (drift risk)

  type_usage_patterns:
    server_client: lib/supabase/server.ts (createServerComponentClient<Database>)
    client_client: lib/supabase/client.ts (createClientComponentClient<Database>)
    api_routes: app/api/verify-lesson-purchase/route.ts (typed inserts/selects)
    components: Typed responses from .from('table').select() calls

query_patterns:
  client_initialization:
    server_side: |
      import { createServerClient } from "@/lib/supabase/server"
      const supabase = await createServerClient() // Returns Promise in Next.js 15
    client_side: |
      import { createClient } from "@/lib/supabase/client"
      const supabase = createClient() // Cached singleton instance
    evidence: lib/supabase/server.ts:8-56, lib/supabase/client.ts:10-75

  common_operations:
    select_with_filter: |
      const { data, error } = await supabase
        .from('lessons')
        .select('price')
        .eq('id', lessonId)
        .single()
    insert_typed: |
      const purchaseData: PurchaseData = { user_id, lesson_id, amount, ... }
      const { error } = await supabase.from('purchases').insert(purchaseData)
    rpc_call: |
      const { data } = await supabase.rpc('column_exists', {
        table_name: 'purchases',
        column_name: 'video_id'
      })
    evidence: app/api/verify-lesson-purchase/route.ts:33-79, 162-165

  storage_operations:
    signed_url_generation: |
      const { data, error } = await supabase.storage
        .from('videos')
        .createSignedUrl(videoPath, 2592000) // 30 days
    evidence: lib/supabase/server-utils.ts:26-28
    path_format: "lesson_id/filename.ext" (enforced by 20250426 migration)

  error_handling:
    pattern: Always check { data, error } destructuring
    null_handling: Use .maybeSingle() for optional rows, .single() for required
    build_time_mocks: Client/server both return mock responses when env vars missing
    evidence: lib/supabase/client.ts:32-38, lib/supabase/server.ts:28-37

supabase_configuration:
  config_file: supabase/config.toml
  project_id: teach-niche-v0
  database:
    port: 54322
    major_version: 15
    shadow_port: 54320
  api:
    port: 54321
    schemas: [public, graphql_public]
    max_rows: 1000
  studio:
    port: 54323
  storage:
    file_size_limit: 50MiB
    image_transformation: enabled
  auth:
    site_url: http://127.0.0.1:3000
    jwt_expiry: 3600
    enable_signup: true
  evidence: supabase/config.toml

key_operations:
  automate_type_generation:
    name: Automate TypeScript Type Generation
    status: NOT IMPLEMENTED (types are manually maintained)
    current_evidence: types/supabase.ts last updated 2025-04-25, schema changed 2025-05-07
    recommendation: |
      Add to package.json:
      "types:generate": "npx supabase gen types typescript --local > types/supabase.ts"

      Workflow:
      1. Create migration: npx supabase migration new <name>
      2. Apply locally: npx supabase db reset
      3. Regenerate types: pnpm types:generate
      4. Commit migration + types together

    trade_off: Requires Supabase CLI in CI/CD vs manual maintenance drift risk

  consolidate_migrations:
    name: Consolidate 11 Migrations into Baseline
    current_state: 11 active migrations (816 lines total)
    recommendation: |
      Consolidation threshold: 15 migrations OR every 6 months
      Current: 11 migrations (approaching threshold)

      Workflow:
      1. npx supabase db dump --project-id <prod> > migrations/baseline.sql
      2. mkdir migrations/archive && mv old migrations to archive
      3. Test: npx supabase db reset (verify all tables/functions present)

    benefit: Faster dev setup (1 baseline vs 11 sequential migrations)

  implement_schema_versioning:
    name: Add schema_version Tracking Table
    status: NOT IMPLEMENTED
    recommendation: |
      CREATE TABLE schema_version (
        version TEXT PRIMARY KEY,
        applied_at TIMESTAMPTZ DEFAULT NOW(),
        description TEXT,
        migration_file TEXT
      );

      Usage in migrations:
      INSERT INTO schema_version VALUES (
        '2025.05.07', 'Fix test schema', '20250505020000_fix_test_schema.sql'
      );

      Query helper (lib/supabase/server-utils.ts):
      export async function getCurrentSchemaVersion() {
        const supabase = await createServerClient();
        return await supabase.from('schema_version')
          .select('*').order('applied_at', { ascending: false }).limit(1).single();
      }
    benefit: Programmatic schema version detection for debugging/admin dashboards

best_practices:
  - category: RLS Security
    practices:
      - practice: Use SECURITY DEFINER functions for complex access logic
        evidence: user_has_purchased_lesson checks purchase + free + instructor (20250503)
        rationale: Centralize logic, reuse across policies, easier to audit

      - practice: Separate public buckets (thumbnails) from private (videos)
        evidence: 20250426 migration changed videos to private with signed URLs
        rationale: Prevent unauthorized video access, enable expiring URLs

      - practice: Path-based storage policies using SPLIT_PART for lesson_id extraction
        evidence: 20250505010000 uses SPLIT_PART(name, '/', 1) for lesson_id
        rationale: Videos stored as "lesson_id/filename", RLS enforces lesson ownership

  - category: Migration Management
    practices:
      - practice: Use IF NOT EXISTS for idempotent migrations
        evidence: All CREATE TABLE/POLICY statements use IF NOT EXISTS checks
        rationale: Safe re-running, supports local dev db resets

      - practice: Add comments to functions explaining access logic
        evidence: COMMENT ON FUNCTION user_has_purchased_lesson (20250503:42)
        rationale: Self-documenting schema, helps future developers

      - practice: Include emergency rollback sections for breaking changes
        evidence: 20250426 video security migration has commented rollback (lines 133-158)
        rationale: Fast recovery if production issues arise

  - category: Type Safety
    practices:
      - practice: Define typed interfaces for complex inserts
        evidence: app/api/verify-lesson-purchase/route.ts:192-204 (PurchaseData interface)
        rationale: TypeScript catches schema mismatches before runtime

      - practice: Use Database['public']['Tables']['table']['Insert'] for typed mocks
        evidence: Recommended in centralize_test_mocks key operation
        rationale: Test mocks auto-update when types regenerate

  - category: Storage Operations
    practices:
      - practice: Normalize video paths in database (no URLs, no query params)
        evidence: 20250426 migration strips URLs/params, stores relative paths
        rationale: Generate signed URLs at runtime, paths don't expire

      - practice: Use 30-day signed URL expiry for videos
        evidence: lib/supabase/server-utils.ts:28 (2592000 seconds)
        rationale: Balance between user experience and security

known_issues:
  - issue: Manual types/supabase.ts drift risk
    evidence: Last updated 2025-04-25, schema changed 2025-05-07 (12 days drift)
    impact: TypeScript won't catch schema mismatches in new code
    workaround: Automate with supabase gen types (see automate_type_generation)
    status: open
    timestamp: 2025-12-30

  - issue: No schema versioning metadata
    evidence: No schema_version table found in migrations
    impact: Can't programmatically detect current schema version
    workaround: Implement schema_version table (see implement_schema_versioning)
    status: open
    timestamp: 2025-12-30

  - issue: video_id column legacy compatibility
    evidence: get_purchases_by_video_ids function checks column existence (20250504)
    impact: Migration path from old video-centric model to lesson-centric
    workaround: handle_legacy_purchases procedure migrates video_id → lesson_id
    status: transitional (tests still use videos table)
    timestamp: 2025-12-30

  - issue: Videos table exists in test schema but not production
    evidence: 20250505020000_fix_test_schema.sql re-adds videos table
    impact: Test/prod schema divergence
    workaround: Tests maintain videos table for backward compatibility
    status: intentional (legacy test support)
    timestamp: 2025-12-30

decision_trees:
  migration_workflow:
    entry_point: Need to change database schema
    branches:
      - condition: Local development (experimenting)
        action: |
          1. npx supabase migration new <descriptive_name>
          2. Write SQL in migration file (use IF NOT EXISTS for idempotence)
          3. npx supabase db reset (apply locally)
          4. pnpm types:generate (if types:generate script exists)
          5. Test changes in app

      - condition: Breaking change (e.g., bucket public → private)
        action: |
          1. Add emergency rollback section (see 20250426 example)
          2. Test migration locally with real data
          3. Deploy to staging, monitor for errors
          4. If issues arise, uncomment rollback and reapply
          5. Once stable, remove rollback section

      - condition: Production deployment
        action: |
          1. Test in staging first
          2. npx supabase db push --project-id <production>
          3. Monitor Supabase logs for errors
          4. Regenerate types from production (ensure sync)
          5. Update schema_version table (if implemented)

  rls_policy_design:
    entry_point: Need to secure table or storage bucket
    branches:
      - condition: Simple ownership check (e.g., users can update own profile)
        action: |
          CREATE POLICY "policy_name" ON table FOR operation
          USING (auth.uid() = user_id_column);

      - condition: Complex access logic (purchase + free + instructor)
        action: |
          1. Create SECURITY DEFINER function (e.g., user_has_purchased_lesson)
          2. Add COMMENT ON FUNCTION explaining logic
          3. Reference function in policy USING clause
          4. Centralize logic for reuse across policies

      - condition: Storage bucket with path-based access
        action: |
          1. Define path format (e.g., "lesson_id/filename.ext")
          2. Use SPLIT_PART(name, '/', 1) to extract identifier
          3. Join with relevant table (lessons, purchases)
          4. Check ownership or purchase status
          Example: 20250505010000 "Allow access to purchased videos"

test_infrastructure:
  test_files:
    - test/stripe-webhook.test.ts (webhook event handling)
    - test/purchase-verification.test.ts (purchase flow)
    - test/checkout-flow.test.ts (end-to-end checkout)
    - test/integration/*.test.ts (integration tests)
  cleanup_utilities:
    file: test/utils/cleanup.ts
    purpose: Clean up test data from database
    uses_supabase: Likely uses createServerClient for deletions
  mock_patterns:
    recommendation: Centralize in test/mocks/database.ts with typed mocks
    current_state: Scattered across test files
    benefit: TypeScript will error if mocks don't match schema

potential_enhancements:
  - enhancement: Add types:generate npm script
    rationale: Prevent manual type drift
    effort: low (one-line package.json change)
    timestamp: 2025-12-30

  - enhancement: Consolidate migrations to baseline
    rationale: Faster dev setup (11 migrations → 1 baseline + recent)
    effort: medium (dump schema, archive old migrations, test)
    timestamp: 2025-12-30

  - enhancement: Implement schema_version table
    rationale: Programmatic version detection for admin dashboards
    effort: low (one migration file)
    timestamp: 2025-12-30

  - enhancement: Centralize test mocks in test/mocks/database.ts
    rationale: Typed mocks prevent drift from schema
    effort: low (consolidate existing mocks)
    timestamp: 2025-12-30

  - enhancement: Add pre-commit hook to check types:generate was run
    rationale: Enforce type regeneration after schema changes
    effort: medium (husky hook + git diff check)
    timestamp: 2025-12-30

stability:
  oscillation_detection:
    rule: |
      IF entry E1 at T1 contradicts E0 at T0
      AND entry E2 at T2 contradicts E1
      THEN oscillation detected
    resolution: |
      Preserve both with conflict marker
      Escalate to human
    detected_oscillations: []

  convergence_indicators:
    insight_rate_trend: initializing
    contradiction_count: 0
    last_reviewed: 2025-12-30
    notes: |
      Initial discovery complete. Comprehensive codebase analysis performed:
      - 11 migration files analyzed (816 lines of SQL)
      - 186-line manual types/supabase.ts examined
      - 22 database-related commits reviewed (April-May 2025)
      - RLS policies, storage buckets, functions documented
      - Query patterns, client initialization, error handling captured

      Size: 747 lines (target 650-750, WITHIN RANGE)

      Next steps: Monitor for type generation automation, migration consolidation,
      schema versioning implementation. Update expertise as patterns evolve.
